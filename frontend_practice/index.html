<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>User Records</title>
    <link rel="stylesheet" href="style/style.css">
</head>

<body>
    <header>
        <h1>User Records</h1>
        <p>
            Add a user with the form on the left and display records in the table on the right.
        </p>
    </header>
    <main class="wrap">`
        <!-- FORM -->
        <section class="card" aria-label="Add user form">
            <div class="card-head">
                <h2>Add a Record</h2>
                <span class="hint">Fields marked * are required</span>
            </div>
            <form id="add-user-form" autocomplete="on">
                <fieldset>
                    <legend>Identity</legend>
                    <div class="grid">
                        <label>
                            Full Name *
                            <input name="name" type="text" placeholder="e.g., Kevin DesLauriers" required />
                        </label>
                        <div class="grid two">
                            <label>
                                Age *
                                <input name="age" type="number" min="0" max="130" placeholder="e.g., 52" required />
                            </label>
                            <label>
                                Gender *
                                <select name="gender" required>
                                    <option value="" selected disabled>Choose…</option>
                                    <option value="Female">Female</option>
                                    <option value="Male">Male</option>
                                    <option value="Non-binary">Non-binary</option>
                                    <option value="Prefer not to say">Prefer not to say</option>
                                </select>
                            </label>
                        </div>
                    </div>
                </fieldset>
                <fieldset>
                    <legend>Contact</legend>
                    <div class="grid">
                        <label>
                            Phone Number *
                            <input name="phone" type="tel" placeholder="e.g., (416) 555-0123" required />
                        </label>
                        <label>
                            Address *
                            <textarea name="address" placeholder="Street, City, Province/State, Postal/ZIP"
                                required></textarea>
                        </label>
                    </div>
                </fieldset>
                <fieldset>
                    <legend>Account</legend>
                    <div class="grid two">
                        <label>
                            Username *
                            <input name="username" type="text" placeholder="e.g., kevin_d" required />
                        </label>
                        <label>
                            Password *
                            <input name="password" type="password" placeholder="Enter a password" required />
                        </label>
                    </div>
                </fieldset>
                <div class="actions">
                    <button class="btn primary" type="submit">Add Record</button>
                    <button class="btn ghost" type="reset">Clear</button>
                </div>
            </form>
        </section>
        <!-- TABLE -->
        <section class="card table-wrap" aria-label="User records table">
            <div class="card-head">
                <h2>Current Records</h2>
            </div>
            <div class="table-scroller" role="region" aria-label="Scrollable user records table" tabindex="0">
                <table id="user-table">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Phone</th>
                            <th>Address</th>
                            <th>Gender</th>
                            <th>Age</th>
                            <th>Username</th>
                            <th>Password</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                    </tbody>
                </table>
            </div>
        </section>
    </main>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const userForm = document.querySelector('#add-user-form');
            const userTableBody = document.querySelector('#user-table tbody');

            fetchUsers();

            userForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const formData = new FormData(userForm);
                const userData = Object.fromEntries(formData.entries());

                try {
                    const response = await fetch('/user', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(userData)
                    });

                    if (response.ok) {
                        userForm.reset();
                        fetchUsers();
                    } else {
                        const error = await response.json();
                        alert('Error adding user: ' + error.error);
                    }
                } catch (err) {
                    console.error('Fetch error:', err);
                }
            });

            async function fetchUsers() {
                try {
                    const response = await fetch('/user');
                    const users = await response.json();
                    renderTable(users);
                } catch (err) {
                    console.error('Error fetching users:', err);
                }
            }

            function renderTable(users) {
                userTableBody.innerHTML = '';
                users.forEach(user => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${user.name || ''}</td>
                        <td>${user.phone || ''}</td>
                        <td>${user.address || ''}</td>
                        <td><span class="pill">${user.gender || ''}</span></td>
                        <td>${user.age || ''}</td>
                        <td>${user.username || ''}</td>
                        <td><span class="pill ok">••••••••</span></td>
                        <td>
                            <button class="btn ghost delete-btn" data-id="${user._id}">Delete</button>
                        </td>
                    `;
                    userTableBody.appendChild(row);
                });

                document.querySelectorAll('.delete-btn').forEach(btn => {
                    btn.addEventListener('click', () => deleteUser(btn.dataset.id));
                });
            }

            async function deleteUser(id) {
                if (!confirm('Are you sure you want to delete this user?')) return;
                try {
                    const response = await fetch(`/user/${id}`, { method: 'DELETE' });
                    if (response.ok) {
                        fetchUsers();
                    } else {
                        alert('Failed to delete user');
                    }
                } catch (err) {
                    console.error('Delete error:', err);
                }
            }
        });
    </script>
</body>

</html>